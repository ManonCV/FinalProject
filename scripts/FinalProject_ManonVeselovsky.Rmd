---
title: "Advanced Stats - Bank Swallow Movement"
output:
  word_document: default
  html_document:
    df_print: paged
  pdf_document: default
date: "2023-04-24"

---

```{r setup, include=FALSE}
# Clear the R workspace environment
rm(list=ls())
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = 'C:/Users/Manon/Documents/BIO8940 - Advanced Statistics/FinalProject') #set the working directory

```
## BIO8940 Final Project
### Bank swallow movements to roosting habitat
### By: Manon Veselovsky - 8259387
### Introduction:
### Various animals across taxa are known to form aggregate groups during their lifecycle. This phenomenon can become problematic when faced with rapid environmental change and the alteration of suitable habitats where this clustering behaviour is centered. For example, during the winter, the eastern migratory monarch butterfly population forms a single roosting colony of millions of individuals in a very small region of oyamel forest in Mexico. While many factors are contributing to declining monarch butterfly populations, one of the most concerning is the human alteration of the  oyamel forests which provide this roosting habitat (_____________). Today, only ___________ remains of the original __________ which could house these overwintering insects. Unfortunately, habitat alteration and loss is only projected to increase as human infrastructure expands, which is likely to continue to threaten certain habitats and species that utilize these habitats. For conservation of habitats to be effective, it is important to understand the degree to which these habitats are being used by endangered species, especially when endangered species aggregate in these areas.
### One highly threatened species whose aggregation ecology requries greater study is the bank swallow (Riparia riparia). The North American bank swallow has declined by _________. Much of its behavioural ecology remains unknown, a shortcoming that must be addressed if this species is to be conserved. Bank swallows form breeding colonies on the banks of lakes and in gravel pits across North America.  yet much about its  recently been discovered as using wetland habitats habitat that has faced significant alteration is that of wetlands in Ontario. In the 1800s, Ontario was composed of over ________ hectares of wetland habitats, but only __________ of this area remains. Wetlands are home to a host of threatened and endangered species.  more surprising is that some aggregation behaviours are only just being in North America. One such example is the bank swallow (Riparia riparia), a bird native to and threatened in North America (_______). The North American bank swallow 
```{r,include=FALSE}

########### LOAD DATA FILES AND LIBRARIES ##########

# #load data files on bank swallow movement
#departure = read.csv("data/departure_dat.csv") #UNCOMMENT TO LOAD CLIMATE DATA AND RUN SECTION 1.1 TO PROCESS DATA

depart_final = read.csv("data/departure_final.csv") #This is the dataset AFTER loading climate variables (done in section 1.1). Retrieving the NCEP climate data takes a long time for each variable (~1h) - skip the climate data retrieving section 1.1 by using this dataset

#load necessary libraries
library(lmerTest) #for glmer
library(car) #for Anova
library(RNCEP) #climate database
library(suncalc) #moon phase/illumination package
library(ggplot2) #for plotting
library(dplyr) #for number of distinct individuals/ids
library(effects) #for effects plots
library(performance) #for diagnostic plots on glmer - normality of random variables
library(DHARMa) #diagnostic plot for dispersion (over/under)
library(datawizard) #for scaling and centering
library(tidyverse) #for data management/processing

```


``` {r, include=FALSE}
############## Section 1.1:  CLIMATE VARIABLES FOR MOVEMENT DATA ########################

# #PLEASE NOTE: RETRIEVING THE CLIMATE DATA TAKES ~1 HOUR PER VARIABLE - this code is included but can be skipped by loading the included data file "depart_final" - line 23
# #IF YOU WISH TO RETRIEVE THE CLIMATE DATA YOURSELF BELOW PLEASE UNCOMMENT & LOAD THE FILE departure_dat.csv (LINE 21) AND UNCOMMENT THE SECTION BELOW


# # get surface air temperature at the detected time and location of the bird (data interpolated between weather stations and between times)
# departure$air_temp = NCEP.interp.surface('air.sig995', departure$lat2, departure$lon2, departure$time_departure, reanalysis2 = FALSE, interpolate.space = TRUE, interpolate.time = TRUE, keep.unpacking.info = FALSE, return.units = TRUE,interp = 'IDW', p = 1, status.bar=FALSE)

# # get precipitable water (total amount) (kg/m^2) in the air at time of detection - same interpolation
# departure$precip = NCEP.interp.surface('pr_wtr.eatm', departure$lat2, departure$lon2, departure$time_departure, reanalysis2 = TRUE, interpolate.space = TRUE, interpolate.time = TRUE, keep.unpacking.info = FALSE, return.units = TRUE,interp = 'IDW', p = 1, status.bar=FALSE)

# # get the precipitation rate for 6 hours after the departure time (kg/m^2/s, equivalent to mm/s); same interpolation
# departure$precip_rate = NCEP.interp.gaussian('prate.sfc',departure$lat2, departure$lon2, departure$time_departure, reanalysis2 = TRUE, interpolate.space = TRUE, interpolate.time = TRUE, keep.unpacking.info = FALSE, return.units = TRUE,interp = 'IDW', p = 1, status.bar=FALSE)

# # Get total cloud cover, in %, for the location of bird detection - same interpolation
# departure$cloud_cover = NCEP.interp.gaussian('tcdc.eatm', departure$lat2, departure$lon2, departure$time_departure, reanalysis2 = TRUE, interpolate.space = TRUE, interpolate.time = TRUE, keep.unpacking.info = FALSE, return.units = TRUE,interp = 'IDW', p = 1, status.bar=FALSE)

# # get the East-West wind component
# departure$uwind = NCEP.interp.surface('uwnd.sig995', departure$lat2, departure$lon2, departure$time_departure, reanalysis2 = TRUE, interpolate.space = TRUE, interpolate.time = TRUE, keep.unpacking.info = FALSE, return.units = TRUE, interp = 'IDW', p = 1, status.bar=TRUE)

# #Get the North/South wind component
# departure$vwind = NCEP.interp.surface('vwnd.sig995', departure$lat2, departure$lon2, departure$time_departure, reanalysis2 = FALSE, interpolate.space = TRUE, interpolate.time = TRUE, keep.unpacking.info = FALSE, return.units = TRUE, interp = 'IDW', p = 1, status.bar=TRUE)

# # assign the final, processed database to depart_final
# depart_final = departure

```

```{r,include=FALSE}
#################### SECTION 1.2 VARIABLE MODIFICATIONS + SCALING VARIABLES IN DATABASE ################

# convert air temperature from Kelvin to degrees Celsius
depart_final$temp = depart_final$air_temp - 273

#get lunar illumination (fraction of the moon that is illuminated) and moon phase at the time the bird was observed (movement to roost could be linked to availability of light)
depart_final$moon = getMoonIllumination(depart_final$time_departure,keep=c("fraction","phase"))

# create a variable for sky illumination by combining cloud cover and illumination of the moon (moon fraction) --> a full moon has a moon fraction of 1; illum will be maximum (100%) when the moon is full and cloud cover is 0
depart_final$illum = depart_final$moon.fraction*(1-depart_final$cloud_cover/100)*100

#convert precipitation rate from mm/s (= kg/m^2/s) to mm/h
depart_final$precip_mmh = depart_final$precip_rate*60*60

# make bird ID read as a factor, not integer
depart_final$id = as.factor(depart_final$id)

#set up a scaled database using standardize from data_wizard (reduces problems in glmer compared to scale())
df.scale = standardize(depart_final,select=c("distance","ordinal_date"))

scale_dist = scale(depart_final$distance)
scaleList_dist = list(scale = attr(scale_dist, "scaled:scale"),
    center = attr(scale_dist, "scaled:center"))

scale_date = scale(depart_final$ordinal_date)
scaleList_date = list(scale = attr(scale_date, "scaled:scale"),
    center = attr(scale_date, "scaled:center"))

```


```{r, echo=FALSE}

####################### SECTION 1.3 EXPLORING VARIABLES #############################

# Plot the probability of roosting in the wetland complex against the distance from the colony to the wetland complex
ggplot(depart_final, aes(x=distance, y=roost)) + geom_point(size=4, alpha=0.5, colour="purple") + stat_smooth(method="glm", formula=y~x, method.args = list(family = "binomial"), colour="purple") + theme_bw() + xlab("Distance to roost site (km)") + ylab("Probability of Roosting") + theme(strip.background = element_rect(fill="white"),axis.title.x=element_text(size=15, vjust=-0.4), axis.title.y=element_text(size=15, vjust=1.5), axis.text.x=element_text(size=15), axis.text.y=element_text(size=15)) + scale_x_continuous(limit=c(25,90), breaks=c(30,40,50,60,70,80,90)) + scale_y_continuous(breaks=c(0,0.10,0.20,0.30,0.40,0.50,0.60,0.70,0.80,0.90,1)) + coord_cartesian(ylim=c(-0.01,1)) + theme(legend.position="none")

# Plot the probability of roosting in the wetland complex against the ordinal date in the season
ggplot(depart_final, aes(x=ordinal_date, y=roost)) + facet_grid(~sex) + geom_point(size=4, alpha=0.5, colour="purple") + stat_smooth(method="glm", formula=y~x, method.args = list(family = "binomial"), colour="purple") + theme_bw() + xlab("Ordinal date") + ylab("Probability of Roosting") + theme(strip.background = element_rect(fill="white"),axis.title.x=element_text(size=15, vjust=-0.4), axis.title.y=element_text(size=15, vjust=1.5), axis.text.x=element_text(size=15), axis.text.y=element_text(size=15)) + scale_x_continuous(limit=c(150,200), breaks=c(150,160,170,180,190,200)) + scale_y_continuous(breaks=c(0,0.10,0.20,0.30,0.40,0.50,0.60,0.70,0.80,0.90,1)) + coord_cartesian(ylim=c(-0.01,1)) + theme(legend.position="none")

# Plot the probability of roosting in the wetland complex against the surface air temperature
ggplot(depart_final, aes(x=temp, y=roost)) + geom_point(size=4, alpha=0.5, colour="purple") + stat_smooth(method="glm", formula=y~x, method.args = list(family = "binomial"), colour="purple") + theme_bw() + xlab("Air temperature (deg C)") + ylab("Probability of Roosting") + theme(strip.background = element_rect(fill="white"),axis.title.x=element_text(size=15, vjust=-0.4), axis.title.y=element_text(size=15, vjust=1.5), axis.text.x=element_text(size=15), axis.text.y=element_text(size=15)) + scale_x_continuous(breaks=c(15,20,25,30)) + scale_y_continuous(breaks=c(0,0.10,0.20,0.30,0.40,0.50,0.60,0.70,0.80,0.90,1)) + coord_cartesian(ylim=c(-0.01,1)) + theme(legend.position="none")

# Plot the probability of roosting in the wetland complex against the total precipitable water in the air column
ggplot(depart_final, aes(x=precip, y=roost)) + geom_point(size=4, alpha=0.5, colour="purple") + stat_smooth(method="glm", formula=y~x, method.args = list(family = "binomial"), colour="purple") + theme_bw() + xlab("Precipitable water (kg/m^2)") + ylab("Probability of Roosting") + theme(strip.background = element_rect(fill="white"),axis.title.x=element_text(size=15, vjust=-0.4), axis.title.y=element_text(size=15, vjust=1.5), axis.text.x=element_text(size=15), axis.text.y=element_text(size=15)) + scale_x_continuous(breaks=c(10,20, 30, 40, 50)) + scale_y_continuous(breaks=c(0,0.10,0.20,0.30,0.40,0.50,0.60,0.70,0.80,0.90,1)) + coord_cartesian(ylim=c(-0.01,1)) + theme(legend.position="none")

# Plot the probability of roosting in the wetland complex against 6-hour averaged precipitation rate
ggplot(depart_final, aes(x=precip_mmh, y=roost)) + geom_point(size=4, alpha=0.5, colour="purple") + stat_smooth(method="glm", formula=y~x, method.args = list(family = "binomial"), colour="purple") + theme_bw() + xlab("Precipitation rate (mm/h)") + ylab("Probability of Roosting") + theme(strip.background = element_rect(fill="white"),axis.title.x=element_text(size=15, vjust=-0.4), axis.title.y=element_text(size=15, vjust=1.5), axis.text.x=element_text(size=15), axis.text.y=element_text(size=15)) + scale_x_continuous() + scale_y_continuous(breaks=c(0,0.10,0.20,0.30,0.40,0.50,0.60,0.70,0.80,0.90,1)) + coord_cartesian(ylim=c(-0.01,1)) + theme(legend.position="none")

# Plot the probability of roosting in the wetland complex against the cloud cover
ggplot(depart_final, aes(x=cloud_cover, y=roost)) + geom_point(size=4, alpha=0.5, colour="purple") + stat_smooth(method="glm", formula=y~x, method.args = list(family = "binomial"), colour="purple") + theme_bw() + xlab("Cloud cover") + ylab("Probability of Roosting") + theme(strip.background = element_rect(fill="white"),axis.title.x=element_text(size=15, vjust=-0.4), axis.title.y=element_text(size=15, vjust=1.5), axis.text.x=element_text(size=15), axis.text.y=element_text(size=15)) + scale_x_continuous(breaks=c(0,25,50,75,100)) + scale_y_continuous(breaks=c(0,0.10,0.20,0.30,0.40,0.50,0.60,0.70,0.80,0.90,1)) + coord_cartesian(ylim=c(-0.01,1)) + theme(legend.position="none")

# Plot the probability of roosting in the wetland complex against the fraction of the moon that is illuminated
ggplot(depart_final, aes(x=moon.fraction, y=roost)) + geom_point(size=4, alpha=0.5, colour="purple") + stat_smooth(method="glm", formula=y~x, method.args = list(family = "binomial"), colour="purple") + theme_bw() + xlab("Moon illumination (%)") + ylab("Probability of Roosting") + theme(strip.background = element_rect(fill="white"),axis.title.x=element_text(size=15, vjust=-0.4), axis.title.y=element_text(size=15, vjust=1.5), axis.text.x=element_text(size=15), axis.text.y=element_text(size=15)) + scale_x_continuous(breaks=c(0,25,50,75,100)) + scale_y_continuous(breaks=c(0,0.10,0.20,0.30,0.40,0.50,0.60,0.70,0.80,0.90,1)) + coord_cartesian(ylim=c(-0.01,1)) + theme(legend.position="none")


# Plot the probability of roosting in the wetland complex against the total illumination of the sky (1/cloud cover * lunar illumination)
ggplot(depart_final, aes(x=illum, y=roost)) + geom_point(size=4, alpha=0.5, colour="purple") + stat_smooth(method="glm", formula=y~x, method.args = list(family = "binomial"), colour="purple") + theme_bw() + xlab("Sky illumination (%)") + ylab("Probability of Roosting") + theme(strip.background = element_rect(fill="white"),axis.title.x=element_text(size=15, vjust=-0.4), axis.title.y=element_text(size=15, vjust=1.5), axis.text.x=element_text(size=15), axis.text.y=element_text(size=15)) + scale_x_continuous(breaks=c(0,25,50,75,100)) + scale_y_continuous(breaks=c(0,0.10,0.20,0.30,0.40,0.50,0.60,0.70,0.80,0.90,1)) + coord_cartesian(ylim=c(-0.01,1)) + theme(legend.position="none")


ggplot(depart_final) + 
  aes(ordinal_date, roost) +
  geom_col() +facet_grid(~sex)+
  scale_fill_identity(guide = "legend")+
  ylab("Count of birds roosting")+
  xlab("Ordinal date")

# ggplot(depart_final) +
#   aes(sex, roost) +
#   geom_col() +
#   scale_fill_identity(guide = "legend")+
#   ylab("Count of birds roosting")+
#   xlab("Sex")

################## 


```


```{r}

################### SECTION 1.4 MODEL BUILDING AND DIAGNOSTIC PLOTS ####################
# model has problems using unscaled data, use df.scale (df where distance and ordinal date were scaled and centered)
m = glmer(roost ~ distance + sex + ordinal_date + sex:ordinal_date + illum + (1|colony/id), data=df.scale, family="binomial",na.action=na.omit)
```

### First, I will examine the normality of the residuals from the random variables using the performance package check_model() function.
```{r, echo=FALSE out.width="80%", out.height="80%"}
#examine normality of random variables (other plots from this function are problematic with binomial models)
check_model(m)
```

```{r, echo=FALSE}
#check for over/under dispersion of the overall model using DHARMa
testDispersion(m) #looks fine
dharm_output = simulateResiduals(fittedModel=m,plot = F)
plot(dharm_output) #this looks fine although the lack of deviation is weird - not much can be gathered from the overall residuals in a binomial model anyways - check individual variables
plotResiduals(dharm_output, form=df.scale$distance) #some overdispersion but not terrible, indicates possible non-linear relationship with distance
plotResiduals(dharm_output, form=df.scale$ordinal_date) #fine
plotResiduals(dharm_output, form=df.scale$sex) #fine
plotResiduals(dharm_output, form=df.scale$id) #some issues but not terrible
plotResiduals(dharm_output, form=df.scale$colony) #some issues but not terrible

#see if transformation to distance helps fit - appears to be a log relationship but cannot take log of my distance variable (produces NAs and unscaled data does not converge) - try negative exponential, sqrt, adding a polynomial term

#sqrt 
m_exp = glmer(roost ~ exp(distance) + sex + ordinal_date + sex:ordinal_date + moon.phase + (1|colony/id), data=df.scale, family="binomial",na.action=na.omit)
plotResiduals(simulateResiduals(fittedModel=m_exp,plot = F), form=df.scale$distance) #fit is not much better

#neg exponential
m_neg = glmer(roost ~ exp(-distance) + sex + ordinal_date + sex:ordinal_date + moon.phase + (1|colony/id), data=df.scale, family="binomial",na.action=na.omit) 
plotResiduals(simulateResiduals(fittedModel=m_neg,plot = F), form=df.scale$distance) #fit is worse

#polynomial
m_sqrd = glmer(roost ~ distance+I(distance^2) + sex + ordinal_date + sex:ordinal_date + moon.phase + (1|colony/id), data=df.scale, family="binomial",na.action=na.omit)
plotResiduals(simulateResiduals(fittedModel=m_sqrd,plot = F), form=df.scale$distance) #fit is about the same
```

### Translations of distance did not help the fit of my model, however, plots are alright (per ________). Therefore, I will continue with my original model. I will now look at the effects of the model, first on the logit scale.

```{r, echo=FALSE, out.width="80%", out.height="80%"}

############################# SECTION 1.5.1 EFFECTS PLOTS ##############################
summary(m)

plot(allEffects(m))

```
### There is a significant relationship with each variable except for the night sky illumination % (illum). However, the effect size is hard to elucidate here as these estimates are on a logistic scale, and on variables that have been scaled (ordinal date and distance). Below I will back-transform these to the observed scale.

```{r, echo=FALSE}
############################# SECTION 1.5.2 EFFECTS PLOTS ON OBSERVED SCALE ##############################

# DISTANCE TRANSFORMATIONS
#get the predicted value, upper and lower CI bounds on the latent/logit scale for predicted roosting probability as a function of distance from colony to roost site
df.scale$dist_logit_ypred = -2.489848 -2.019687*df.scale$distance #get the predicted value on the logit scale using scaled distance value
df.scale$dist_logit_upper = df.scale$dist_logit_ypred+0.315909*1.96 #get upper confidence interval bound on logit
df.scale$dist_logit_lower = df.scale$dist_logit_ypred-0.315909*1.96 #get lower CI bound on logit

#convert these predicted logit values to the observed scale
depart_final$dist_ypred = 1 / (1 + exp(-df.scale$dist_logit_ypred))
depart_final$dist_upper = 1 / (1 + exp(-df.scale$dist_logit_upper))
depart_final$dist_lower = 1 / (1 + exp(-df.scale$dist_logit_lower))

#plot the predicted values on the observed scale with the un-scaled distance values
ggplot(depart_final,aes(distance,dist_ypred,
               ymin=dist_lower,ymax=dist_upper,legend="FALSE",
               ))+
     geom_line()+theme(legend.position="none")+
     geom_ribbon(alpha=0.2,colour=NA)+ylab("Probability of roosting")+xlab("Distance to roost site (km)")+
     geom_rug(sides="b") + theme(strip.background = element_rect(fill="white"),axis.title.x=element_text(size=15, vjust=-0.4), axis.title.y=element_text(size=15, vjust=1.5),axis.text.x=element_text(size=15), axis.text.y=element_text(size=15))

```
### Here, we can see that the distance to the wetland site has a significant effect on whether the wetland roost will be used. If the wetland habitat is within 10 km, the swallows are estimated to use them to roost at night 50%-60% of the time. There is a significant drop in roosting use with distance to the wetland. At >50 km from the colony, the birds will only use the roost at an estimated mean of ~13% of the time (with 95% confidence interval maximum being ~22%), 1/4th the use of wetlands within 10 km. Beyond this, the wetland begins to be used <10% of the time.
### I will continue with my exploration of effects, looking at the interaction of the bird's sex and the ordinal date of the season next.

```{r, echo=FALSE}

# ORDINAL DATE TRANSFORMATIONS
#view estimate for ordinal date
summary(m)
#get the predicted value, upper and lower CI bounds on the logit scale for Ordinal date
df.scale$date_logit_ypred = -2.489848 + 1.630949*df.scale$ordinal_date #get the predicted value on the logit scale using scaled distance value
df.scale$date_logit_upper = df.scale$date_logit_ypred+0.160221*1.96 #get upper confidence interval bound on logit
df.scale$date_logit_lower = df.scale$date_logit_ypred-0.160221*1.96 #get lower CI bound on logit

#convert these values to the observed scale
depart_final$date_ypred = 1 / (1 + exp(-df.scale$date_logit_ypred))
depart_final$date_upper = 1 / (1 + exp(-df.scale$date_logit_upper))
depart_final$date_lower = 1 / (1 + exp(-df.scale$date_logit_lower))


#plot the predicted values of roosting probability on the observed scale with the un-scaled ordinal date values - THIS IS THE RELATIONSHIP FOR FEMALES
ggplot(depart_final,aes(ordinal_date,date_ypred,
               ymin=date_lower,ymax=date_upper,legend="FALSE",
               ))+
     geom_line()+theme(legend.position="none")+ theme_bw()+
     geom_ribbon(alpha=0.2,colour=NA)+ylab("Probability of roosting (Female)")+xlab("Ordinal date")+
     geom_rug(sides="b") + theme(strip.background = element_rect(fill="white"),axis.title.x=element_text(size=15, vjust=-0.4), axis.title.y=element_text(size=15, vjust=1.5), axis.text.x=element_text(size=15), axis.text.y=element_text(size=15))+ scale_x_continuous() + scale_y_continuous(breaks=c(0,0.10,0.20,0.30,0.40,0.50,0.60,0.70,0.80,0.90,1))+coord_cartesian(ylim = c(0, 0.9))

#get the same plot for males (this is the interaction component of sex:ordinal_date) - function is: ordinal_date_male prediction = intercept + male_estimate + (ordinal_date_estimate + male:ordinal_date_estimate)*scaled_ordinal_date
df.scale$date_m_logit_ypred = -2.489848 + 0.724532 + (1.630949-0.455592)*df.scale$ordinal_date #get the predicted value on the logit scale using scaled distance value
df.scale$date_m_logit_upper = df.scale$date_m_logit_ypred+0.20704*1.96 #get upper confidence interval bound on logit
df.scale$date_m_logit_lower = df.scale$date_m_logit_ypred-0.20704*1.96 #get lower CI bound on logit

#convert these predicted values from logit scale to the observed scale 1/(1 + exp(-prediction))
depart_final$date_m_ypred = 1 / (1 + exp(-df.scale$date_m_logit_ypred))
depart_final$date_m_upper = 1 / (1 + exp(-df.scale$date_m_logit_upper))
depart_final$date_m_lower = 1 / (1 + exp(-df.scale$date_m_logit_lower))

#plot the relationship for males
ggplot(depart_final,aes(ordinal_date,date_m_ypred,
               ymin=date_m_lower,ymax=date_m_upper,legend="FALSE",
               ))+
     geom_line()+theme(legend.position="none")+
     geom_ribbon(alpha=0.2,colour=NA)+ylab("Probability of roosting (Male)")+xlab("Ordinal date")+theme_bw()+
     geom_rug(sides="b") + theme(strip.background = element_rect(fill="white"),axis.title.x=element_text(size=15, vjust=-0.4), axis.title.y=element_text(size=15, vjust=1.5), axis.text.x=element_text(size=15), axis.text.y=element_text(size=15))+ scale_x_continuous() + scale_y_continuous(breaks=c(0,0.10,0.20,0.30,0.40,0.50,0.60,0.70,0.80,0.90,1))+coord_cartesian(ylim = c(0, 0.9))

#plot both male and female relationship with ordinal date on the same plot - dashed lines for 95% CIs for each respective group - could not change 95% lines to match - ideally change the values above to an if statement, calculate only for values where sex = M and sex = F, respectively, and put them under a single column
ggplot(depart_final,aes(ordinal_date))+
  geom_line(aes(y=date_m_ypred,colour="Male"))+geom_line(aes(y=date_ypred,colour="Female"))+
  geom_line(aes(y=date_m_ypred,colour="Male"))+geom_line(aes(y=date_ypred,colour="Female"))+
  geom_line(aes(y=date_m_upper,colour="Male 95% CI"),linetype = "dashed")+geom_line(aes(y=date_m_lower,colour="Male 95% CI"),linetype = "dashed")+
  geom_line(aes(y=date_upper,colour="Female 95% CI"),linetype = "dashed")+geom_line(aes(y=date_lower,colour="Female 95% CI"),linetype = "dashed")+
  theme(legend.position="none")+
     ylab("Probability of roosting")+xlab("Ordinal date")+theme_bw()+
     geom_rug(sides="b") + theme(strip.background = element_rect(fill="white"),axis.title.x=element_text(size=15, vjust=-0.4), axis.title.y=element_text(size=15, vjust=1.5), axis.text.x=element_text(size=15), axis.text.y=element_text(size=15))+ scale_x_continuous() + scale_y_continuous(breaks=c(0,0.10,0.20,0.30,0.40,0.50,0.60,0.70,0.80,0.90,1))+coord_cartesian(ylim = c(0, 0.9))
```
### Here we can see the effect of the interaction sex and ordinal date. Before the ordinal date of 171, there is no overlap of 95% CIs between the two sexes. During this early breeding season period, males use wetlands to roost significantly more often. At ordinal date 170, it's estimated that ~12.5% of males are using the wetlands to roost at night, in contrast to only ~6% of females. This shows twice as many males using the wetlands compared to females in the early breeding period. This greater use of roosts by males was previously observed in a small sample of bank swallows (n = 12) in this same study system (@Falconer2016). It is hypothesized that this difference could be due to females having to provide warmth to their young. Before 8 days old, chicks are unable to regulate their own body temperature, and rely on the warmth from their mother (@Marsh1979). Thus, females likely cannot leave the colony to roost before this period is over.
### We see that this greater use of wetlands by males compared to females continues for the majority of the breeding season, although after day 171 this difference is not as significant (overlap of the 95% CIs). Interestingly, it seems that males and females could be swapping their overall use of the wetland late in the season, with the mean estimate for females beginning to exceed that of males around ordinal date 187. After this, the estimated use of wetlands by females is about  1/10th greater than males. However, the 95% CIs do overlap here, indicating this observation could be due to chance.

```{r}
#get the same plot for males (this is the interaction component of sex:ordinal_date)
df.scale$illum_logit_ypred = -2.489848 - 0.003178*depart_final$illum #get the predicted value on the logit scale
df.scale$illum_logit_upper = df.scale$illum_logit_ypred+0.003160*1.96 #get upper confidence interval on logit
df.scale$illum_logit_lower = df.scale$illum_logit_ypred-0.003160*1.96 #get lower CI on logit

#convert these values to the observed scale
depart_final$illum_ypred = 1 / (1 + exp(-df.scale$illum_logit_ypred))
depart_final$illum_upper = 1 / (1 + exp(-df.scale$illum_logit_upper))
depart_final$illum_lower = 1 / (1 + exp(-df.scale$illum_logit_lower))

ggplot(depart_final,aes(illum,illum_ypred,
               ymin=illum_lower,ymax=illum_upper,legend="FALSE",
               ))+
     geom_line()+theme(legend.position="none")+
     geom_ribbon(alpha=0.2,colour=NA)+ylab("Probability of roosting")+xlab("illum to roost site (km)")+
     geom_rug(sides="b") + theme(strip.background = element_rect(fill="white"),axis.title.x=element_text(size=15, vjust=-0.4), axis.title.y=element_text(size=15, vjust=1.5),axis.text.x=element_text(size=15), axis.text.y=element_text(size=15))+ scale_y_continuous(breaks=c(0,0.10,0.20,0.30,0.40,0.50,0.60,0.70,0.80,0.90,1))+coord_cartesian(ylim = c(0, 0.9))
plot(allEffects(m))
plot(effect("illum",m))

effects_m = allEffects(m)
effect_dist = as.data.frame(effects_m$distance)
effect_dist_unscaled = effect_dist
effect_dist_unscaled$distance = effect_dist$distance*scaleList_dist$scale + scaleList_dist$center
effect_dist_unscaled
ggplot(effect_dist_unscaled,aes(distance,fit,
               ymin=lower,ymax=upper,legend="FALSE",
               ))+
     geom_line()+theme(legend.position="none")+
     geom_ribbon(alpha=0.2,colour=NA)+ylab("Probability of roosting")+xlab("Distance to roost site (km)")+
     geom_rug(sides="b") + theme(strip.background = element_rect(fill="white"),axis.title.x=element_text(size=15, vjust=-0.4), axis.title.y=element_text(size=15, vjust=1.5), axis.text.x=element_text(size=15), axis.text.y=element_text(size=15))


```

```{r, echo=FALSE}
############### plots of random effects
r1 = as.data.frame(ranef(m, condVar = TRUE, whichel = c("id", "colony")))
p1 = ggplot(subset(r1, grpvar == "id"), aes(y = grp, x = condval)) +
  geom_point() +
  geom_pointrange(
    aes(xmin = condval - condsd * 1.96, xmax = condval + condsd * 1.96)
  ) +
  geom_vline(aes(xintercept = 0, color = "red")) +
  theme_classic() +
  theme(legend.position = "none")
p2 = ggplot(subset(r1, grpvar == "colony"), aes(y = grp, x = condval)) +
  geom_point() +
  geom_pointrange(
    aes(xmin = condval - condsd * 1.96, xmax = condval + condsd * 1.96)
  ) +
  geom_vline(aes(xintercept = 0, color = "red")) +
  theme_classic() +
  theme(legend.position = "none")
p1 + p2


r5 = as.data.frame(ranef(m))
ggplot(data = r5, aes(sample = condval)) +
  geom_qq() + geom_qq_line() +
  facet_wrap(~ grpvar) +
  theme_classic()
```